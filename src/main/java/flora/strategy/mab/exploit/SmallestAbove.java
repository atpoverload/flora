package flora.strategy.mab.exploit;

import static java.util.Comparator.comparing;

import flora.Knob;
import flora.strategy.mab.ExploitationPolicy;
import flora.strategy.mab.MultiArmedBanditContext;
import java.util.Map;

/**
 * An {@link ExploitationPolicy} that selects the configuration with a reward nearest to a value.
 */
public final class SmallestAbove implements ExploitationPolicy {
  private final double value;

  public SmallestAbove(double value) {
    this.value = value;
  }

  /** Returns the config with smallest average reward above {@code value}. */
  @Override
  public Map<String, Knob> exploit(MultiArmedBanditContext context) {
    return context.getConfigurations().stream()
        .filter(k -> context.getReward(k) / context.getRewardCount(k) < value)
        .min(comparing(k -> Math.abs(context.getAverageReward(k))))
        .orElseThrow(
            () -> new IllegalStateException("Exploitation was requested with no evaluations."));
  }
}
